<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Game ‚Äî Yorimichi</title>
  <link rel="stylesheet" href="public/css.css">
</head>
<body>
  <div id="game">
    <div class="world" id="world">
      <div class="layer bg-grad"></div>

      <div class="hud">
        <div class="badges">
          <span class="badge"><span data-t="hudStage">„Çπ„ÉÜ„Éº„Ç∏</span>: <b id="stageNum"></b></span>
          <span class="badge"><span data-t="hudAttachment">ÊÑõÁùÄ</span>: <b id="bondVal">0</b></span>
        </div>
        <div class="row"><button onclick="location.href='index.html'">‚â°</button></div>
      </div>

      <div class="track"></div>
      <div id="markers" class="layer"></div>

      <img id="sprite" class="sprite face-right" alt="buddy" style="display:none;bottom:0px">
      <div id="shadow" class="shadow-ellipse" style="bottom:0px"></div>
    </div>
  </div>

  <div id="modal" class="modal" style="display:none"></div>

  <div class="minitools" id="miniTools" style="display:none">
    <button id="btnGuide">Â∞é„Åè</button>
    <button id="btnWatch" class="flat">Ë¶ãÂÆà„Çã</button>
    <button id="btnIgnore" class="flat">ÊîæÁΩÆ</button>
  </div>

  <script src="public/js_i18n.js"></script>
  <script src="public/js_state.js"></script>

  <script>
    (function(){
      window.addEventListener('error', e=>{
        const d=document.createElement('div'); d.className='err';
        d.textContent='Error: '+(e.message||e.error||'unknown');
        document.body.appendChild(d);
      });
      window.addEventListener('unhandledrejection', e=>{
        const d=document.createElement('div'); d.className='err';
        d.textContent='Promise rejection: '+(e.reason && e.reason.message ? e.reason.message : e.reason);
        document.body.appendChild(d);
      });
    })();
  </script>

  <script type="module">
    if (typeof window.applyTexts !== 'function') window.applyTexts = ()=>{};
    if (!window.go) window.go = (u)=>location.href = u;
    const Y = window.Y_STATE || {
      get:(k,d)=>{try{const v=localStorage.getItem(k);return v!==null?JSON.parse(v):d;}catch{return d}},
      set:(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}}
    };

    applyTexts();

    (function setTimeBG(){
      const h = new Date().getHours();
      document.body.classList.add(h<10?'time-morning':h<16?'time-noon':'time-evening');
    })();

    if (window.matchMedia && matchMedia('(pointer:fine)').matches){
      const game = document.getElementById('game');
      function applyTilt(xRatio){
        const ry = (xRatio-0.5)*-6;
        game.style.setProperty('--ry', ry.toFixed(2)+'deg');
      }
      window.addEventListener('pointermove', e=>{
        applyTilt(e.clientX/window.innerWidth);
      }, {passive:true});
      applyTilt(.5);
    }

    const SPRITE_BASE = 'public/characters/';
    const ITEM_BASE   = 'public/items/';
    const CHAR_SPRITE = { blue:'blue_closed.png', green:'green_open.png', pink:'pink_closed.png', purple:'purple_closed.png' };
    const TRANSPARENT_1PX = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR4nGNgYAAAAAMAASsJTYQAAAAASUVORK5CYII=";

    const STAGES = [
      {id:1, place:"ÂÖ¨Âúí„ÅÆÂ∞èÈÅì", dest:"„Éô„É≥„ÉÅ", events:[
        {id:"f1", text:"„ÅäËä±„Åå„ÅÇ„Çã„ÄÇ", icon:"üå∏", x:.18, kind:"flower", dur:8000, delta:{guide:+2, watch:+1, ignore:-1}},
        {id:"c1", text:"Áå´„Å°„ÇÉ„Çì‚Ä¶„Å™„Åß„Åü„ÅÑ„Å™", x:.32, kind:"generic", dur:6000, delta:{guide:+1, watch:+1, ignore:-1}},
        {id:"i1", text:"„Ç¢„Ç§„Çπ‚Ä¶Â∞ë„Åó„Å†„Åë", x:.48, kind:"generic", dur:5000, delta:{guide:+1, watch:0, ignore:-1}},
        {id:"b1", text:"Â∞èÈ≥•„ÅÆ„Åï„Åà„Åö„Çä", x:.68, kind:"generic", dur:5000, delta:{guide:0, watch:+1, ignore:0}},
        {id:"f2", text:"„ÇÇ„ÅÜ‰∏ÄÊ†™„Åç„Çå„ÅÑ„Å™Ëä±", icon:"üå∏", x:.82, kind:"flower", dur:7000, delta:{guide:+1, watch:+1, ignore:-1}},
      ]},
      {id:2, place:"„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞Ë°ó", dest:"Âõ≥Êõ∏È§®", events:[
        {id:"g1", text:"„Ç≤„Éº„É†„Çª„É≥„Çø„Éº‚Ä¶", x:.20, kind:"generic", dur:6000, delta:{guide:+1, watch:0, ignore:-1}},
        {id:"s1", text:"„Çª„Éº„É´„Å†‚Ä¶", x:.36, kind:"generic", dur:6000, delta:{guide:+1, watch:0, ignore:-1}},
        {id:"c2", text:"„Ç´„Éï„Çß„ÅÆÁîò„ÅÑÂåÇ„ÅÑ", x:.55, kind:"generic", dur:5000, delta:{guide:0, watch:+1, ignore:0}},
        {id:"sns", text:"SNSÈÄöÁü•„ÅåÊ∞ó„Å´„Å™„Çã", x:.76, kind:"generic", dur:5000, delta:{guide:+1, watch:0, ignore:-1}},
      ]},
      {id:3, place:"ÈÄöÂ≠¶Ë∑Ø", dest:"Â≠¶Ê†°„ÅÆÈñÄ", events:[
        {id:"fr", text:"Âèã„Å†„Å°„ÅåÂõ∞„Å£„Å¶„Çã‚Ä¶", x:.28, kind:"generic", dur:7000, delta:{guide:+1, watch:+1, ignore:-2}},
        {id:"wl", text:"ËêΩ„Å®„ÅóÁâ©„ÅÆË≤°Â∏É", x:.50, kind:"generic", dur:6000, delta:{guide:+1, watch:+1, ignore:-1}},
        {id:"mc", text:"Ê≥£„ÅÑ„Å¶„ÇãÂ≠ê„Å©„ÇÇ", x:.72, kind:"generic", dur:7000, delta:{guide:+1, watch:+1, ignore:-2}},
      ]},
      {id:4, place:"Êµ∑Ëæ∫„ÅÆÈÅäÊ≠©ÈÅì", dest:"ÁÅØÂè∞", events:[
        {id:"sea", text:"Ê≥¢Êâì„Å°Èöõ„ÅßÈÅä„Å≥„Åü„ÅÑ", x:.22, kind:"generic", dur:6000, delta:{guide:+1, watch:+1, ignore:-1}},
        {id:"sh1", text:"„ÅÇ„ÄÅË≤ù„ÇíÊãæ„Åä„ÅÜ„ÄÇ", icon:"üêö", x:.44, kind:"shell", dur:8000, delta:{guide:+1, watch:+1, ignore:-1}},
        {id:"busk", text:"Ë∑Ø‰∏äÊºîÂ•è„ÅåÂøÉÂú∞„ÅÑ„ÅÑ", x:.66, kind:"generic", dur:6000, delta:{guide:0, watch:+1, ignore:0}},
        {id:"sh2", text:"„ÇÇ„ÅÜ‰∏Ä„Å§ÂÖâ„ÇãË≤ù", icon:"üêö", x:.84, kind:"shell", dur:7000, delta:{guide:+1, watch:+1, ignore:-1}},
      ]},
      {id:5, place:"ÊïÖÈÉ∑„ÅÆÁî∫", dest:"ÊÄù„ÅÑÂá∫„ÅÆÂ†¥ÊâÄ", events:[
        {id:"ph", text:"Êòî„ÅÆÂÜôÁúü‚Ä¶", x:.30, kind:"generic", dur:6000, delta:{guide:+1, watch:+1, ignore:0}},
        {id:"dg", text:"ÈßÑËèìÂ≠êÂ±ã„ÅÆÂâç„ÅßË∂≥„ÅåÊ≠¢„Åæ„Çã", x:.52, kind:"generic", dur:5000, delta:{guide:0, watch:+1, ignore:0}},
        {id:"fr2", text:"Êáê„Åã„Åó„ÅÑ‰∫∫„Å´‰ºö„Å£„Åü", x:.74, kind:"generic", dur:7000, delta:{guide:+1, watch:+1, ignore:0}},
      ]},
      {id:6, place:"ÁóÖÈô¢Âë®Ëæ∫", dest:"„ÅäË¶ãËàû„ÅÑ", events:[
        {id:"wh", text:"Ëªä„ÅÑ„Åô„ÅÆ‰∫∫„ÇíÊâã‰ºù„ÅÜÔºü", x:.26, kind:"generic", dur:7000, delta:{guide:+2, watch:+1, ignore:-1}},
        {id:"fl", text:"Â£≤Â∫ó„ÅÆËä±„ÇíÈÅ∏„Å≥„Åü„ÅÑ", icon:"üå∏", x:.50, kind:"flower", dur:7000, delta:{guide:0, watch:+2, ignore:0}},
        {id:"bn", text:"Ê≥£„ÅÑ„Å¶„ÅÑ„Çã‰∫∫„Åå„ÅÑ„Çã", x:.74, kind:"generic", dur:7000, delta:{guide:+1, watch:+1, ignore:-1}},
      ]},
      {id:7, place:"ÂàÜ„Åã„ÇåÈÅì„ÅÆË°ó", dest:"Á¥ÑÊùü„ÅÆÂ†¥ÊâÄ", events:[
        {id:"sc", text:"ËøëÈÅì‚Ä¶„Åß„ÇÇÈÄ≤ÂÖ•Á¶ÅÊ≠¢", x:.32, kind:"generic", dur:6000, delta:{guide:+1, watch:0, ignore:-1}},
        {id:"cr", text:"Áæ§Ë°Ü„Å´ÊµÅ„Åï„Çå„Åù„ÅÜ", x:.56, kind:"generic", dur:6000, delta:{guide:+1, watch:0, ignore:-1}},
        {id:"rs", text:"Ââç„ÅÆÂ§±Êïó„ÇíÊÄù„ÅÑÂá∫„Åô", x:.80, kind:"generic", dur:6000, delta:{guide:+1, watch:+1, ignore:0}},
      ]},
      {id:8, place:"ÂçíÊ•≠Âºè„Å∏", dest:"ÂºèÂÖ∏‰ºöÂ†¥", events:[
        {id:"mm", text:"ÊúÄÂæå„ÅÆÊÄù„ÅÑÂá∫„Å•„Åè„Çä", x:.30, kind:"generic", dur:6000, delta:{guide:0, watch:+2, ignore:-1}},
        {id:"fu", text:"Â∞ÜÊù•„ÅÆ‰∏çÂÆâ„Åå„Çà„Åé„Çã", x:.54, kind:"generic", dur:6000, delta:{guide:+1, watch:+1, ignore:0}},
        {id:"fr3", text:"Âèã„Å†„Å°„Å®Âà•„Çå„ÅÆÊôÇÈñì", x:.78, kind:"generic", dur:6000, delta:{guide:0, watch:+2, ignore:0}},
      ]},
      {id:9, place:"Â§ïÊöÆ„Çå„ÅÆÊ≤≥Â∑ùÊï∑", dest:"ÊÄù„ÅÑÂá∫„ÅÆ„Éô„É≥„ÉÅ", events:[
        {id:"rk", text:"Âç±„Å™„ÅÑÂ†¥ÊâÄ„Å´ÊÉπ„Åã„Çå„Çã", x:.34, kind:"generic", dur:8000, delta:{guide:+1, watch:+1, ignore:-2}},
        {id:"ind", text:"‰∏Ä‰∫∫„ÅßÊ±∫„ÇÅ„Åü„ÅÑÊ∞óÊåÅ„Å°", x:.60, kind:"generic", dur:7000, delta:{guide:0, watch:+1, ignore:0}},
      ]},
      {id:10, place:"ÈßÖ„ÅÆ„Éó„É©„ÉÉ„Éà„Éï„Ç©„Éº„É†", dest:"ÊóÖÁ´ã„Å°„ÅÆÈõªËªä", events:[
        {id:"st", text:"Ë∂≥„Åå„Åô„Åè„ÇÄ", x:.28, kind:"generic", dur:6000, delta:{guide:0, watch:+1, ignore:0}},
        {id:"rv", text:"ÊóÖ„ÅÆË®òÊÜ∂„Åå„Çà„Åø„Åå„Åà„Çã", x:.56, kind:"generic", dur:6000, delta:{guide:+1, watch:+1, ignore:0}},
        {id:"fw", text:"Êú¨ÂΩì„Å´Ë°å„Åè„ÅÆ‚Ä¶Ôºü", x:.82, kind:"generic", dur:7000, delta:{guide:0, watch:+2, ignore:-1}},
      ]},
    ];

    const sprite   = document.getElementById('sprite');
    const shadowEl = document.getElementById('shadow');
    const markers  = document.getElementById('markers');
    const modal    = document.getElementById('modal');
    const stageNum = document.getElementById('stageNum');
    const bondVal  = document.getElementById('bondVal');
    const mini     = document.getElementById('miniTools');

    const char = Y.get('yorimichi.character','pink');
    let stageIndex = Math.min(Math.max(1,Y.get('yorimichi.stage',1)), 10);
    let attachment = Y.get('yorimichi.attachment',0);
    stageNum.textContent = stageIndex; bondVal.textContent = attachment;

    function setSpriteByChar(c){
      const url = SPRITE_BASE + (CHAR_SPRITE[c] || CHAR_SPRITE.pink);
      const img = new Image();
      img.onload  = ()=>{ sprite.src = url; sprite.style.display='block'; };
      img.onerror = ()=>{ sprite.src = TRANSPARENT_1PX; sprite.style.display='block'; console.warn('Sprite not found:', url); };
      img.src = url;
    }
    setSpriteByChar(char);

    const BASE_SPEED_VW_PER_SEC = 1.95;
    let px = 6;
    let lastTs = performance.now();
    let prevPx = px;

    function baseBottomPx(){ return window.innerHeight*0.45 - 40; }
    let bottomOffset = 0;

    function applySpritePos(extraXvw=0){
      const left = (px + extraXvw);
      const bottomPx = baseBottomPx() + bottomOffset;
      sprite.style.left = left + 'vw';
      sprite.style.bottom = bottomPx + 'px';
      shadowEl.style.left = left + 'vw';
      shadowEl.style.bottom = (baseBottomPx() - 14) + 'px';
      const elWidth = Math.min(window.innerWidth*0.18, 160);
      const k = Math.max(0.45, 1 - bottomOffset/160);
      shadowEl.style.width = (elWidth*0.75*k) + 'px';
      shadowEl.style.height = (26*k) + 'px';
      shadowEl.style.opacity = (0.9*k).toFixed(2);
    }

    const stage = STAGES[stageIndex-1];
    markers.innerHTML = '';
    stage.events.forEach(ev=>{
      const x = Math.floor(ev.x*100);
      const m = document.createElement('div');
      m.className = 'marker';
      m.style.left = x+'vw';
      m.dataset.id = ev.id;
      m.dataset.kind = ev.kind || 'generic';
      m.dataset.text = ev.text || '';
      m.dataset.icon = ev.icon || '';
      m.innerHTML = `<div class="dot"></div><div class="label"></div>`;
      markers.appendChild(m);
    });

    let detouring = false, detourEndTime = 0, detourItemEl = null, activeEvent = null;

    const REVEAL_DIST = 78;
    const TRIGGER_DIST = 26;

    function revealIfNear(){
      const vw = window.innerWidth/100;
      const r = sprite.getBoundingClientRect();
      const sx = r.left + r.width*0.5;
      document.querySelectorAll('.marker').forEach(m=>{
        const mx = parseFloat(m.style.left)*vw;
        const d = Math.abs(mx - sx);
        if(d < REVEAL_DIST && !m.classList.contains('revealed')){
          const kind = m.dataset.kind;
          const icon = m.dataset.icon || (kind==='flower'?'üå∏':kind==='shell'?'üêö':'');
          const label = m.querySelector('.label');
          label.textContent = icon ? `${icon} ${m.dataset.text}` : m.dataset.text;
          m.classList.add('revealed');
        }
      });
    }

    function checkEventTrigger(){
      if(detouring) return;
      const vw = window.innerWidth/100;
      const r = sprite.getBoundingClientRect();
      const sx = r.left + r.width*0.5;
      const near = Array.from(document.querySelectorAll('.marker')).find(m=>{
        const mx = parseFloat(m.style.left)*vw;
        return Math.abs(mx - sx) < TRIGGER_DIST;
      });
      if(near){
        const ev = stage.events.find(e=>e.id===near.dataset.id);
        startDetour(ev);
        near.remove();
      }
    }

    function showBubble(text){
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      document.body.appendChild(b);
      const r = sprite.getBoundingClientRect();
      b.style.left = (r.left + r.width*0.5) + 'px';
      b.style.top  = (r.top - 10) + 'px';
      setTimeout(()=>b.remove(), 1000);
    }

    function startDetour(ev){
      detouring = true; activeEvent = ev;
      detourEndTime = performance.now() + (ev.dur||6000);
      bottomOffset = 70;
      sprite.classList.remove('paused');
      mini.style.display = 'flex';
      showBubble('‚Ä¶');

      if(detourItemEl){ detourItemEl.remove(); detourItemEl=null; }
      const r = sprite.getBoundingClientRect();
      detourItemEl = document.createElement('div');
      detourItemEl.className = 'float-item';
      detourItemEl.style.left = (r.left + r.width*0.75) + 'px';
      detourItemEl.style.top  = (r.top - 10) + 'px';

      if(ev.kind==='flower'){
        detourItemEl.classList.add('flower');
        detourItemEl.textContent = 'üå∏';
        detourItemEl.onclick = ()=> shortenDetour(0.5);
      }else if(ev.kind==='shell'){
        detourItemEl.classList.add('shell');
        detourItemEl.innerHTML = `<img src="${ITEM_BASE}asari3.png" alt="shell">`;
        detourItemEl.onclick = ()=>{ shortenDetour(0.5); detourItemEl.remove(); };
      }
      document.body.appendChild(detourItemEl);
    }
    function shortenDetour(rate){
      const now = performance.now();
      const remain = Math.max(0, detourEndTime - now);
      detourEndTime = now + remain * (1-rate);
    }
    function extendDetour(ms){ detourEndTime += ms; }
    function endDetour(){
      detouring = false; activeEvent = null; bottomOffset = 0; mini.style.display = 'none';
      if(detourItemEl){ detourItemEl.remove(); detourItemEl=null; }
    }

    document.getElementById('btnGuide').onclick = ()=>{
      if(!detouring) return;
      attachment += (activeEvent?.delta?.guide||0);
      bondVal.textContent = attachment; Y.set('yorimichi.attachment', attachment);
      shortenDetour(0.6); showBubble('ÔºÅ');
    };
    document.getElementById('btnWatch').onclick = ()=>{
      if(!detouring) return;
      attachment += (activeEvent?.delta?.watch||0);
      bondVal.textContent = attachment; Y.set('yorimichi.attachment', attachment);
      showBubble('‚Ä¶');
    };
    document.getElementById('btnIgnore').onclick = ()=>{
      if(!detouring) return;
      attachment += (activeEvent?.delta?.ignore||0);
      bondVal.textContent = attachment; Y.set('yorimichi.attachment', attachment);
      extendDetour(2500); showBubble('Ôºü');
    };

    let touchY=null, swipeSum=0;
    window.addEventListener('wheel', e=>{
      if(detouring){ shortenDetour( Math.min(1, Math.abs(e.deltaY)/600) ); }
    }, {passive:true});
    window.addEventListener('touchstart', e=>{
      if(e.touches[0]) touchY=e.touches[0].clientY;
    }, {passive:true});
    window.addEventListener('touchmove', e=>{
      if(detouring && e.touches[0] && touchY!=null){
        const dy = touchY - e.touches[0].clientY;
        swipeSum += dy;
        if(Math.abs(swipeSum) > 40){ shortenDetour(0.25); swipeSum=0; }
      }
    }, {passive:true});
    window.addEventListener('touchend', ()=>{ touchY=null; }, {passive:true});

    function updateFacing(){
      const v = px - prevPx;
      if (v > 0.02) { sprite.classList.add('face-right'); sprite.classList.remove('face-left'); }
      else if (v < -0.02) { sprite.classList.add('face-left'); sprite.classList.remove('face-right'); }
      prevPx = px;
    }

    function endStage(){
      modal.style.display='flex';
      modal.innerHTML = `<div class="sheet" style="text-align:center">
        <h3>Âà∞ÁùÄÔºÅ</h3>
        <p class="small">${stage.place} ‚Üí <b>${stage.dest}</b></p>
        <div class="actionbar"><button class="primary" id="nextBtn">${stageIndex<10?'Ê¨°„Å∏':'„É°„Éã„É•„Éº„Å´Êàª„Çã'}</button></div>
      </div>`;
      document.getElementById('nextBtn').onclick = ()=>{
        if(stageIndex<10){ stageIndex++; Y.set('yorimichi.stage', stageIndex); location.reload(); }
        else{ go('index.html'); }
      };
    }

    function step(ts){
      const dt = (ts - lastTs) / 1000; lastTs = ts;

      if(detouring){
        const sway = Math.sin(ts/400) * 1.2;
        applySpritePos(sway);
        updateFacing();
        if(ts >= detourEndTime){ endDetour(); }
      }else{
        px += BASE_SPEED_VW_PER_SEC * dt;
        applySpritePos();
        updateFacing();
        revealIfNear();
        checkEventTrigger();
      }

      if(px >= 94){ endStage(); return; }
      requestAnimationFrame(step);
    }

    function init(){
      Y.set('yorimichi.lastPage','game.html');
      applySpritePos();
      requestAnimationFrame(step);
    }
    init();

    window.addEventListener('resize', ()=> applySpritePos(), {passive:true});
  </script>
</body>
</html>
