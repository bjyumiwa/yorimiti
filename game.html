<!DOCTYPE html>
if (detourRemain <= 0) endDetour('natural');
} else {
// 左へ自動歩行
const xvw = Number(friendEl.dataset.xvw);
const nx = xvw - BASE_SPEED_VW_PER_SEC * dt;
friendEl.dataset.xvw = String(nx);
friendEl.style.left = `${nx}vw`;
shadowEl.style.left = `${nx}vw`;


// ラベル/発火
updateLabelsAndTriggers();


// 到着
if (nx <= GOAL_X_VW) {
// 簡易：背景を更新して再配置（次の景色へ）。満足度+4。
incSat(4);
genGeoBackground();
friendEl.dataset.xvw = String(START_X_VW);
friendEl.style.left = `${START_X_VW}vw`;
shadowEl.style.left = `${START_X_VW}vw`;
// イベントも再利用（完了フラグを解除）
stage.events.forEach(ev=>{ ev._done=false; ev._in=false; ev._el?.classList.remove('done','reveal'); });
}
}


requestAnimationFrame(tick);
}


// レイアウト初期化
function initLayout(){
// 道ライン位置
roadEl.style.top = `${PATH_Y_VH}vh`;
shadowEl.style.top = `calc(${PATH_Y_VH}vh + 0.6vh)`;
friendEl.style.top = `${PATH_Y_VH}vh`;
}


// エラー表示
function showError(msg){ errorbar.textContent = String(msg || ''); errorbar.classList.toggle('show', !!msg); }
window.addEventListener('error', (e)=>{ showError(e.message || 'Error'); });
window.addEventListener('unhandledrejection', (e)=>{ showError(e.reason?.message || 'Promise rejection'); });


// 起動
try {
applyTexts?.();
genGeoBackground();
renderSat();
initFriend();
initLayout();
buildStage();
requestAnimationFrame(tick);
} catch (err) {
console.error(err); showError(err.message || err);
}
</script>
</body>
</html>
