<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Game â€” Yorimichi</title>
  <link rel="stylesheet" href="public/css.css">
</head>
<body>
  <div id="game">
    <div class="bg-grad"></div>

    <div class="hud">
      <div class="badges">
        <span class="badge"><span data-t="hudStage">ã‚¹ãƒ†ãƒ¼ã‚¸</span>: <b id="stageNum"></b></span>
        <span class="badge"><span data-t="hudAttachment">æ„›ç€</span>: <b id="bondVal">0</b></span>
      </div>
      <div class="row"><button onclick="location.href='index.html'">â‰¡</button></div>
    </div>

    <div class="track"></div>
    <!-- åº§æ¨™ã¯JSã§æ›´æ–°ã€‚ç¸¦ä½ç½®ã¯ãƒ”ã‚¯ã‚»ãƒ«ã§åˆ¶å¾¡ã—ã¦â€œé“ã‹ã‚‰ãµã‚ã£ã¨å¤–ã‚Œã‚‹â€ -->
    <img id="sprite" class="sprite face-right" alt="buddy" style="display:none;bottom:0px">
    <div id="markers"></div>
  </div>

  <!-- åˆ°ç€ã®ã¿ã§ä½¿ã†è»½ã„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="modal" class="modal" style="display:none"></div>

  <!-- å³ä¸‹ã®ãƒŸãƒ‹ãƒ»ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒãƒ¼ï¼ˆå°ã•ã‚ï¼‰ -->
  <div class="minitools" id="miniTools" style="display:none">
    <button id="btnGuide">å°ã</button>
    <button id="btnWatch" class="flat">è¦‹å®ˆã‚‹</button>
    <button id="btnIgnore" class="flat">æ”¾ç½®</button>
  </div>

  <script src="public/js_i18n.js"></script>
  <script src="public/js_state.js"></script>
  <script>
    applyTexts();

    // èƒŒæ™¯ï¼šç«¯æœ«æ™‚åˆ»ã§ã‚¯ãƒ©ã‚¹ä»˜ä¸ï¼ˆæœ/æ˜¼/å¤•ï¼‰
    (function setTimeBG(){
      const h = new Date().getHours();
      const cls = (h<10) ? 'time-morning' : (h<16) ? 'time-noon' : 'time-evening';
      document.body.classList.add(cls);
    })();

    // ç”»åƒãƒ‘ã‚¹ï¼ˆå‰æï¼‰
    const SPRITE_BASE = 'public/characters/';
    const ITEM_BASE   = 'public/items/';
    const CHAR_SPRITE = { blue:'blue_closed.png', green:'green_open.png', pink:'pink_closed.png', purple:'purple_closed.png' };

    // ã‚¹ãƒ†ãƒ¼ã‚¸ï¼ˆ1ã‚·ãƒ¼ãƒ³â‰’60sç›®å®‰ï¼šå‰é€²ï¼‹å¯„ã‚Šé“ã§èª¿æ•´ï¼‰
    // kind: 'flower' | 'shell' | 'generic'
    const STAGES = [
      {id:1, place:"å…¬åœ’ã®å°é“", dest:"ãƒ™ãƒ³ãƒ", events:[
        {id:"flower", text:"ãŠèŠ±ãŒã‚ã‚‹ã€‚", x:.32, kind:"flower", dur:9000, delta:{guide:+2, watch:+1, ignore:-1}},
        {id:"cat",    text:"çŒ«ã¡ã‚ƒã‚“â€¦ãªã§ãŸã„ãª", x:.56, kind:"generic", dur:7000, delta:{guide:+1, watch:+1, ignore:-1}},
      ]},
      {id:2, place:"ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°è¡—", dest:"å›³æ›¸é¤¨", events:[
        {id:"game", text:"ã‚²ãƒ¼ãƒ ã‚»ãƒ³ã‚¿ãƒ¼â€¦å°‘ã—ã ã‘", x:.35, kind:"generic", dur:6000, delta:{guide:+1, watch:0, ignore:-1}},
        {id:"sale", text:"ã‚»ãƒ¼ãƒ«ã â€¦è¦‹ã‚‹ã ã‘ãªã‚‰",   x:.62, kind:"generic", dur:6000, delta:{guide:+1, watch:0, ignore:-1}},
      ]},
      {id:3, place:"é€šå­¦è·¯", dest:"å­¦æ ¡ã®é–€", events:[
        {id:"friend", text:"å‹ã ã¡ãŒå›°ã£ã¦ã‚‹â€¦", x:.45, kind:"generic", dur:8000, delta:{guide:+1, watch:+1, ignore:-2}},
      ]},
      {id:4, place:"æµ·è¾ºã®éŠæ­©é“", dest:"ç¯å°", events:[
        {id:"shell", text:"ã‚ã€è²ã‚’æ‹¾ãŠã†ã€‚", x:.50, kind:"shell", dur:9000, delta:{guide:+1, watch:+1, ignore:-1}},
      ]},
      {id:5, place:"æ•…éƒ·ã®ç”º", dest:"æ€ã„å‡ºã®å ´æ‰€", events:[
        {id:"photo", text:"æ˜”ã®å†™çœŸâ€¦", x:.52, kind:"generic", dur:6000, delta:{guide:+1, watch:+1, ignore:0}},
      ]},
      {id:6, place:"ç—…é™¢å‘¨è¾º", dest:"ãŠè¦‹èˆã„", events:[
        {id:"wheel", text:"æ‰‹ä¼ã£ãŸæ–¹ãŒâ€¦", x:.50, kind:"generic", dur:7000, delta:{guide:+2, watch:+1, ignore:-1}},
      ]},
      {id:7, place:"åˆ†ã‹ã‚Œé“ã®è¡—", dest:"ç´„æŸã®å ´æ‰€", events:[
        {id:"shortcut", text:"è¿‘é“â€¦ã§ã‚‚â€¦", x:.50, kind:"generic", dur:6000, delta:{guide:+1, watch:0, ignore:-1}},
      ]},
      {id:8, place:"å’æ¥­å¼ã¸", dest:"å¼å…¸ä¼šå ´", events:[
        {id:"last", text:"æœ€å¾Œã®æ€ã„å‡ºâ€¦", x:.55, kind:"generic", dur:6000, delta:{guide:0, watch:+2, ignore:-1}},
      ]},
      {id:9, place:"å¤•æš®ã‚Œã®æ²³å·æ•·", dest:"æ€ã„å‡ºã®ãƒ™ãƒ³ãƒ", events:[
        {id:"risk", text:"å±ãªã„ã‘ã©â€¦", x:.50, kind:"generic", dur:8000, delta:{guide:+1, watch:+1, ignore:-2}},
      ]},
      {id:10, place:"é§…ã®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ", dest:"æ—…ç«‹ã¡ã®é›»è»Š", events:[
        {id:"farewell", text:"æœ¬å½“ã«è¡Œãã®â€¦ï¼Ÿ", x:.50, kind:"generic", dur:7000, delta:{guide:0, watch:+2, ignore:-1}},
      ]},
    ];

    const sprite   = document.getElementById('sprite');
    const markers  = document.getElementById('markers');
    const modal    = document.getElementById('modal');
    const stageNum = document.getElementById('stageNum');
    const bondVal  = document.getElementById('bondVal');
    const mini     = document.getElementById('miniTools');

    const char = Y_STATE.get('yorimichi.character','pink');
    let stageIndex = Math.min(Math.max(1,Y_STATE.get('yorimichi.stage',1)), 10);
    let attachment = Y_STATE.get('yorimichi.attachment',0);
    stageNum.textContent = stageIndex; bondVal.textContent = attachment;

    // ã‚¹ãƒ—ãƒ©ã‚¤ãƒˆèª­è¾¼
    function setSpriteByChar(c){
      const url = SPRITE_BASE + (CHAR_SPRITE[c] || CHAR_SPRITE.pink);
      const img = new Image();
      img.onload  = ()=>{ sprite.src = url; sprite.style.display='block'; };
      img.onerror = ()=>{ console.warn('Sprite not found:', url); };
      img.src = url;
    }
    setSpriteByChar(char);

    // é€²è¡Œãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆç´„60sç›®å®‰ï¼šå‰é€²ç´„45s + å¯„ã‚Šé“åˆ†ã§ãƒˆãƒ¼ã‚¿ãƒ«â‰’60sï¼‰
    const BASE_SPEED_VW_PER_SEC = 1.8; // 88vw / 49s â‰’ 1.8
    let px = 6; // vw
    let lastTs = performance.now();

    // ç¸¦åº§æ¨™ï¼ˆpxï¼‰â€¦ãƒ™ãƒ¼ã‚¹ä½ç½®ï¼ˆé“ï¼‰ã¨å¯„ã‚Šé“ã‚ªãƒ•ã‚»ãƒƒãƒˆ
    function baseBottomPx(){ return window.innerHeight*0.45 - 40; }
    let bottomOffset = 0; // detourä¸­ã¯ +60px ä»˜è¿‘ã¸
    function applySpritePos(extraXvw=0){
      sprite.style.left = (px + extraXvw) + 'vw';
      sprite.style.bottom = (baseBottomPx() + bottomOffset) + 'px';
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒãƒ¼ã‚«ãƒ¼ï¼‰
    const stage = STAGES[stageIndex-1];
    markers.innerHTML = '';
    stage.events.forEach(ev=>{
      const x = Math.floor(ev.x*100);
      const m = document.createElement('div');
      m.className = 'marker';
      m.style.left = x+'vw';
      m.dataset.id = ev.id;
      m.innerHTML = `<div class="dot"></div><div class="label">${ev.text}</div>`;
      markers.appendChild(m);
    });

    // å¯„ã‚Šé“çŠ¶æ…‹
    let detouring = false;
    let detourEndTime = 0;
    let detourItemEl = null;
    let activeEvent = null;
    let scrollAccumulator = 0;

    function startDetour(ev){
      detouring = true;
      activeEvent = ev;
      detourEndTime = performance.now() + (ev.dur||6000);
      bottomOffset = 70; // ãµã‚ã£ã¨é“ã‹ã‚‰ä¸Šã¸
      sprite.classList.remove('paused');
      mini.style.display = 'flex'; // å°ã•ã„ãƒœã‚¿ãƒ³
      showBubble('â€¦');

      // ã‚¢ã‚¤ãƒ†ãƒ é…ç½®ï¼ˆèŠ±ã‹ã‚¢ã‚µãƒªï¼‰
      if(detourItemEl){ detourItemEl.remove(); detourItemEl=null; }
      const r = sprite.getBoundingClientRect();
      detourItemEl = document.createElement('div');
      detourItemEl.className = 'float-item';
      detourItemEl.style.left = (r.left + r.width*0.7) + 'px';
      detourItemEl.style.top  = (r.top - 10) + 'px';

      if(ev.kind==='flower'){
        detourItemEl.classList.add('flower');
        detourItemEl.textContent = 'ğŸŒ¸';
        detourItemEl.onclick = ()=> shortenDetour(0.5); // 50%çŸ­ç¸®
      }else if(ev.kind==='shell'){
        detourItemEl.classList.add('shell');
        detourItemEl.innerHTML = `<img src="${ITEM_BASE}asari3.png" alt="shell">`;
        detourItemEl.onclick = ()=>{ shortenDetour(0.5); detourItemEl.remove(); };
      }else{
        // generic ã¯ã‚¢ã‚¤ãƒ†ãƒ ç„¡ã—
      }
      document.body.appendChild(detourItemEl);
    }
    function shortenDetour(rate){ // æ®‹æ™‚é–“ã‚’å‰²åˆã§çŸ­ç¸®
      const now = performance.now();
      const remain = Math.max(0, detourEndTime - now);
      detourEndTime = now + remain * (1-rate);
    }
    function extendDetour(ms){
      detourEndTime += ms;
    }
    function endDetour(){
      detouring = false;
      activeEvent = null;
      bottomOffset = 0;
      mini.style.display = 'none';
      if(detourItemEl){ detourItemEl.remove(); detourItemEl=null; }
    }

    // å°ã•ã„ãƒœã‚¿ãƒ³ã®åŠ¹ãï¼ˆå°ã=çŸ­ç¸® / è¦‹å®ˆã‚‹=å¤‰åŒ–ãªã— / æ”¾ç½®=å»¶é•·ï¼‰
    document.getElementById('btnGuide').onclick = ()=>{
      if(!detouring) return;
      attachment += (activeEvent?.delta?.guide||0);
      bondVal.textContent = attachment; Y_STATE.set('yorimichi.attachment', attachment);
      shortenDetour(0.6); showBubble('ï¼');
    };
    document.getElementById('btnWatch').onclick = ()=>{
      if(!detouring) return;
      attachment += (activeEvent?.delta?.watch||0);
      bondVal.textContent = attachment; Y_STATE.set('yorimichi.attachment', attachment);
      showBubble('â€¦');
    };
    document.getElementById('btnIgnore').onclick = ()=>{
      if(!detouring) return;
      attachment += (activeEvent?.delta?.ignore||0);
      bondVal.textContent = attachment; Y_STATE.set('yorimichi.attachment', attachment);
      extendDetour(2500); showBubble('ï¼Ÿ');
    };

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«/ã‚¹ãƒ¯ã‚¤ãƒ—ã§å¯„ã‚Šé“çŸ­ç¸®
    window.addEventListener('wheel', e=>{
      if(detouring){ shortenDetour( Math.min(1, Math.abs(e.deltaY)/600) ); }
    }, {passive:true});
    let touchY=null;
    window.addEventListener('touchstart', e=>{ if(e.touches[0]) touchY=e.touches[0].clientY; }, {passive:true});
    window.addEventListener('touchmove', e=>{
      if(detouring && e.touches[0] && touchY!=null){
        const dy = touchY - e.touches[0].clientY; // ä¸Šã¸å¼•ãã¨çŸ­ç¸®
        scrollAccumulator += dy;
        if(Math.abs(scrollAccumulator) > 40){
          shortenDetour(0.25);
          scrollAccumulator = 0;
        }
      }
    }, {passive:true});
    window.addEventListener('touchend', ()=>{ touchY=null; }, {passive:true});

    // è¿‘æ¥æ¤œçŸ¥ï¼ˆå¯„ã‚Šé“ä¸­ã¯ç™ºç«ã—ãªã„ï¼‰
    function checkEventProximity(){
      if(detouring) return;
      const vw = window.innerWidth/100;
      const r = sprite.getBoundingClientRect();
      const sx = r.left + r.width*0.5;
      const near = Array.from(document.querySelectorAll('.marker')).find(m=>{
        const mx = parseFloat(m.style.left)*vw;
        return Math.abs(mx - sx) < 30;
      });
      if(near){
        const ev = stage.events.find(e=>e.id===near.dataset.id);
        startDetour(ev);
        near.remove(); // ä¸€åº¦ãã‚Š
      }
    }

    // åˆ°ç€UIï¼ˆæŒ¯ã‚Šè¿”ã‚Šç„¡ã—ï¼‰
    function endStage(){
      modal.style.display='flex';
      modal.innerHTML = `<div class="sheet" style="text-align:center">
        <h3>åˆ°ç€ï¼</h3>
        <p class="small">${stage.place} â†’ <b>${stage.dest}</b></p>
        <div class="actionbar"><button class="primary" id="nextBtn">${stageIndex<10?'æ¬¡ã¸':'ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹'}</button></div>
      </div>`;
      document.getElementById('nextBtn').onclick = ()=>{
        if(stageIndex<10){ stageIndex++; Y_STATE.set('yorimichi.stage', stageIndex); location.reload(); }
        else{ go('index.html'); }
      };
    }

    function showBubble(text){
      const b = document.createElement('div');
      b.className = 'bubble';
      b.textContent = text;
      document.body.appendChild(b);
      const r = sprite.getBoundingClientRect();
      b.style.left = (r.left + r.width*0.5) + 'px';
      b.style.top  = (r.top - 10) + 'px';
      setTimeout(()=>b.remove(), 1000);
    }

    // ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ—ï¼ˆæ™‚é–“ãƒ™ãƒ¼ã‚¹ï¼‰
    function step(ts){
      const dt = (ts - lastTs) / 1000; // ç§’
      lastTs = ts;

      if(detouring){
        // ãµã‚ãƒ¼ã£ã¨å¤–ã‚Œã¦æ¼‚ã†ï¼ˆå·¦å³ã‚†ã‚‰ãï¼‰
        const sway = Math.sin(ts/400) * 1.2; // vw
        applySpritePos(sway);
        if(ts >= detourEndTime){ endDetour(); }
      }else{
        // å‰é€²ï¼ˆå³ã¸ï¼‰
        px += BASE_SPEED_VW_PER_SEC * dt;
        applySpritePos();
        checkEventProximity();
      }

      // ã‚´ãƒ¼ãƒ«
      if(px >= 94){ endStage(); return; }
      requestAnimationFrame(step);
    }

    function init(){
      localStorage.setItem('yorimichi.lastPage','game.html');
      // åˆæœŸé…ç½®
      applySpritePos();
      requestAnimationFrame(step);
    }
    init();

    // ç”»é¢ã‚µã‚¤ã‚ºå¤‰åŒ–ã§ã‚‚ç¸¦ä½ç½®ã‚’ç¶­æŒ
    window.addEventListener('resize', ()=> applySpritePos(), {passive:true});
  </script>
</body>
</html>
