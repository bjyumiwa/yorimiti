import React, { useState, useEffect, useRef } from 'react';

const WalkingGame = () => {
  const [currentScene, setCurrentScene] = useState(0);
  const [playerX, setPlayerX] = useState(400);
  const [playerY, setPlayerY] = useState(300);
  const [isWalking, setIsWalking] = useState(true);
  const [score, setScore] = useState(0);
  const [gameMessage, setGameMessage] = useState('');
  const [isDragging, setIsDragging] = useState(false);
  const [collectedItems, setCollectedItems] = useState([]);
  const [gameOver, setGameOver] = useState(false);
  const [walkingSpeed] = useState(1);

  const gameRef = useRef(null);

  const scenes = [
    {
      name: "花畑の道",
      background: "linear-gradient(to bottom, #87CEEB, #98FB98)",
      obstacles: [
        { type: "hole", x: 300, y: 400, width: 80, height: 60 },
        { type: "hole", x: 500, y: 350, width: 70, height: 50 }
      ],
      distractions: [
        { type: "flower", x: 200, y: 200, emoji: "🌸" },
        { type: "flower", x: 600, y: 250, emoji: "🌺" },
        { type: "butterfly", x: 450, y: 180, emoji: "🦋" }
      ]
    },
    {
      name: "森の小道",
      background: "linear-gradient(to bottom, #228B22, #32CD32)",
      obstacles: [
        { type: "cliff", x: 0, y: 450, width: 200, height: 100 },
        { type: "hole", x: 400, y: 380, width: 90, height: 70 }
      ],
      distractions: [
        { type: "mushroom", x: 150, y: 300, emoji: "🍄" },
        { type: "squirrel", x: 550, y: 200, emoji: "🐿️" },
        { type: "acorn", x: 350, y: 250, emoji: "🌰" }
      ]
    },
    {
      name: "川辺の道",
      background: "linear-gradient(to bottom, #87CEEB, #ADD8E6)",
      obstacles: [
        { type: "river", x: 100, y: 400, width: 600, height: 80 },
        { type: "hole", x: 250, y: 300, width: 60, height: 50 }
      ],
      distractions: [
        { type: "fish", x: 400, y: 440, emoji: "🐠" },
        { type: "stone", x: 180, y: 350, emoji: "🪨" },
        { type: "frog", x: 520, y: 380, emoji: "🐸" }
      ]
    },
    {
      name: "岩場の道",
      background: "linear-gradient(to bottom, #D2691E, #CD853F)",
      obstacles: [
        { type: "cliff", x: 600, y: 300, width: 200, height: 200 },
        { type: "hole", x: 200, y: 400, width: 100, height: 80 },
        { type: "hole", x: 450, y: 350, width: 80, height: 60 }
      ],
      distractions: [
        { type: "crystal", x: 320, y: 250, emoji: "💎" },
        { type: "lizard", x: 150, y: 300, emoji: "🦎" },
        { type: "cactus", x: 550, y: 200, emoji: "🌵" }
      ]
    },
    {
      name: "お花見の道",
      background: "linear-gradient(to bottom, #FFB6C1, #FFC0CB)",
      obstacles: [
        { type: "hole", x: 350, y: 380, width: 120, height: 90 },
        { type: "cliff", x: 0, y: 420, width: 150, height: 80 }
      ],
      distractions: [
        { type: "sakura", x: 200, y: 150, emoji: "🌸" },
        { type: "sakura", x: 500, y: 200, emoji: "🌸" },
        { type: "bee", x: 400, y: 250, emoji: "🐝" },
        { type: "picnic", x: 300, y: 300, emoji: "🧺" }
      ]
    },
    {
      name: "夕暮れの道",
      background: "linear-gradient(to bottom, #FF6347, #FF7F50)",
      obstacles: [
        { type: "hole", x: 250, y: 350, width: 80, height: 70 },
        { type: "cliff", x: 500, y: 400, width: 300, height: 100 }
      ],
      distractions: [
        { type: "firefly", x: 180, y: 280, emoji: "✨" },
        { type: "owl", x: 450, y: 200, emoji: "🦉" },
        { type: "moon", x: 600, y: 150, emoji: "🌙" }
      ]
    },
    {
      name: "砂漠の道",
      background: "linear-gradient(to bottom, #F4A460, #DEB887)",
      obstacles: [
        { type: "quicksand", x: 200, y: 380, width: 150, height: 100 },
        { type: "cliff", x: 550, y: 350, width: 250, height: 150 },
        { type: "hole", x: 400, y: 320, width: 70, height: 60 }
      ],
      distractions: [
        { type: "camel", x: 150, y: 250, emoji: "🐪" },
        { type: "oasis", x: 500, y: 200, emoji: "🏝️" },
        { type: "snake", x: 350, y: 280, emoji: "🐍" }
      ]
    },
    {
      name: "雪の道",
      background: "linear-gradient(to bottom, #E6E6FA, #F0F8FF)",
      obstacles: [
        { type: "ice", x: 300, y: 350, width: 200, height: 120 },
        { type: "hole", x: 150, y: 400, width: 90, height: 70 }
      ],
      distractions: [
        { type: "snowman", x: 200, y: 250, emoji: "⛄" },
        { type: "rabbit", x: 450, y: 280, emoji: "🐰" },
        { type: "icicle", x: 550, y: 200, emoji: "🧊" }
      ]
    },
    {
      name: "竹林の道",
      background: "linear-gradient(to bottom, #228B22, #90EE90)",
      obstacles: [
        { type: "hole", x: 250, y: 380, width: 100, height: 80 },
        { type: "cliff", x: 500, y: 420, width: 300, height: 80 }
      ],
      distractions: [
        { type: "panda", x: 180, y: 280, emoji: "🐼" },
        { type: "bamboo", x: 400, y: 200, emoji: "🎋" },
        { type: "dragonfly", x: 350, y: 250, emoji: "🪰" }
      ]
    },
    {
      name: "ゴール地点",
      background: "linear-gradient(to bottom, #FFD700, #FFA500)",
      obstacles: [
        { type: "final_pit", x: 350, y: 400, width: 150, height: 80 }
      ],
      distractions: [
        { type: "treasure", x: 400, y: 250, emoji: "🏆" },
        { type: "rainbow", x: 300, y: 150, emoji: "🌈" },
        { type: "celebration", x: 200, y: 200, emoji: "🎉" }
      ]
    }
  ];

  useEffect(() => {
    let interval;
    if (isWalking && !gameOver) {
      interval = setInterval(() => {
        setPlayerX(prev => {
          const newX = prev + walkingSpeed;
          if (newX > 750) {
            if (currentScene < scenes.length - 1) {
              setCurrentScene(prev => prev + 1);
              return 50;
            } else {
              setGameMessage("おめでとう！ゴールです！🎉");
              setIsWalking(false);
              return prev;
            }
          }
          return newX;
        });
        
        // Check for obstacles
        const scene = scenes[currentScene];
        scene.obstacles.forEach(obstacle => {
          if (playerX >= obstacle.x && playerX <= obstacle.x + obstacle.width &&
              playerY >= obstacle.y && playerY <= obstacle.y + obstacle.height) {
            setGameMessage(`${obstacle.type}に落ちた！スクロールで戻して！`);
            setIsWalking(false);
          }
        });
      }, 50);
    }
    return () => clearInterval(interval);
  }, [isWalking, currentScene, playerX, playerY, gameOver]);

  const handleMouseDown = (e) => {
    setIsDragging(true);
  };

  const handleMouseMove = (e) => {
    if (isDragging) {
      const rect = gameRef.current.getBoundingClientRect();
      const newX = e.clientX - rect.left;
      const newY = e.clientY - rect.top;
      
      setPlayerX(Math.max(50, Math.min(750, newX)));
      setPlayerY(Math.max(150, Math.min(450, newY)));
      
      if (newY < 350) {
        setGameMessage("道に戻りました！");
        setIsWalking(true);
      }
    }
  };

  const handleMouseUp = () => {
    setIsDragging(false);
  };

  const handleTouchStart = (e) => {
    e.preventDefault();
    setIsDragging(true);
  };

  const handleTouchMove = (e) => {
    e.preventDefault();
    if (isDragging) {
      const touch = e.touches[0];
      const rect = gameRef.current.getBoundingClientRect();
      const newX = touch.clientX - rect.left;
      const newY = touch.clientY - rect.top;
      
      setPlayerX(Math.max(50, Math.min(750, newX)));
      setPlayerY(Math.max(150, Math.min(450, newY)));
      
      if (newY < 350) {
        setGameMessage("道に戻りました！");
        setIsWalking(true);
      }
    }
  };

  const handleTouchEnd = (e) => {
    e.preventDefault();
    setIsDragging(false);
  };

  const collectItem = (item, index) => {
    setCollectedItems(prev => [...prev, item]);
    setScore(prev => prev + 10);
    setGameMessage(`${item.emoji}を見つけた！+10点`);
    
    // Remove the item from the scene
    scenes[currentScene].distractions.splice(index, 1);
  };

  const currentSceneData = scenes[currentScene];

  return (
    <div className="w-full h-screen bg-gray-800 flex flex-col items-center justify-center p-4">
      <div className="mb-4 text-white text-center">
        <h1 className="text-2xl font-bold mb-2">寄り道の散歩ゲーム</h1>
        <div className="flex gap-4 text-sm">
          <div>シーン: {currentScene + 1}/10 - {currentSceneData.name}</div>
          <div>スコア: {score}</div>
          <div>収集: {collectedItems.length}個</div>
        </div>
      </div>

      <div 
        ref={gameRef}
        className="relative w-[800px] h-[500px] border-4 border-white rounded-lg overflow-hidden cursor-crosshair"
        style={{ background: currentSceneData.background }}
        onMouseDown={handleMouseDown}
        onMouseMove={handleMouseMove}
        onMouseUp={handleMouseUp}
        onTouchStart={handleTouchStart}
        onTouchMove={handleTouchMove}
        onTouchEnd={handleTouchEnd}
      >
        {/* Path */}
        <div className="absolute top-0 left-0 w-full h-[350px] bg-gradient-to-b from-transparent to-yellow-200 opacity-30"></div>
        
        {/* Obstacles */}
        {currentSceneData.obstacles.map((obstacle, index) => (
          <div
            key={index}
            className={`absolute ${
              obstacle.type === 'hole' ? 'bg-black rounded-full' :
              obstacle.type === 'cliff' ? 'bg-gray-600' :
              obstacle.type === 'river' ? 'bg-blue-400' :
              obstacle.type === 'quicksand' ? 'bg-yellow-600' :
              obstacle.type === 'ice' ? 'bg-blue-200' :
              obstacle.type === 'final_pit' ? 'bg-red-800' :
              'bg-gray-500'
            }`}
            style={{
              left: obstacle.x,
              top: obstacle.y,
              width: obstacle.width,
              height: obstacle.height
            }}
          >
            {obstacle.type === 'hole' && <div className="text-center text-white text-xs mt-2">穴</div>}
            {obstacle.type === 'cliff' && <div className="text-center text-white text-xs mt-2">崖</div>}
            {obstacle.type === 'river' && <div className="text-center text-white text-xs mt-6">川</div>}
          </div>
        ))}

        {/* Distractions */}
        {currentSceneData.distractions.map((item, index) => (
          <div
            key={index}
            className="absolute cursor-pointer hover:scale-110 transition-transform"
            style={{ left: item.x, top: item.y }}
            onClick={() => collectItem(item, index)}
          >
            <div className="text-3xl animate-pulse">{item.emoji}</div>
          </div>
        ))}

        {/* Player */}
        <div
          className="absolute text-3xl transition-all duration-200 z-10"
          style={{ 
            left: playerX - 15, 
            top: playerY - 15,
            transform: isDragging ? 'scale(1.2)' : 'scale(1)'
          }}
        >
          🚶‍♂️
        </div>

        {/* Collected items display */}
        <div className="absolute top-2 right-2 bg-black bg-opacity-50 text-white p-2 rounded">
          <div className="text-xs">収集したアイテム:</div>
          <div className="flex flex-wrap gap-1 mt-1">
            {collectedItems.slice(-10).map((item, index) => (
              <span key={index} className="text-lg">{item.emoji}</span>
            ))}
          </div>
        </div>
      </div>

      {/* Game message */}
      <div className="mt-4 text-white text-center min-h-[60px] bg-black bg-opacity-50 p-4 rounded-lg w-[800px]">
        <div className="text-lg">{gameMessage}</div>
        <div className="text-sm mt-2 text-gray-300">
          {isWalking ? "自動で歩いています。寄り道アイテムをクリックして収集しよう！" : 
           "指でドラッグして道に戻してください！"}
        </div>
      </div>

      {/* Instructions */}
      <div className="mt-4 text-white text-xs text-center max-w-[800px]">
        <div>🎮 遊び方：キャラクターは自動で歩きます。穴や崖に落ちたら、ドラッグして道に戻しましょう！</div>
        <div>✨ 寄り道要素をクリックして収集するとスコアがアップします！</div>
      </div>
    </div>
  );
};

export default WalkingGame;
